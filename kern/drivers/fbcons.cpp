#include "fbcons.h"

#include <kernel/config.h>
#ifdef CONFIG_FBCONS

#include <base/types.h>
#include <arch/x86/asm/pg.h>
#include <kernel/bootinfo.h>
#include "../mm/vmm.h"
#include "stdio.h"

extern struct boot_info __kernel_boot_info;

namespace fbcons {

// =========================================================================
// 8x16 bitmap font (CP437 / VGA style)
// Each character is 16 bytes (16 rows of 8 pixels, 1 bit per pixel).
// Only printable ASCII (32..126) is included; everything else renders as '?'.
// =========================================================================
static constexpr int FONT_W = 8;
static constexpr int FONT_H = 16;

// clang-format off
static const uint8_t font8x16[95][16] = {
    // 32 ' ' (space)
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // 33 '!'
    {0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    // 34 '"'
    {0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // 35 '#'
    {0x00,0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00},
    // 36 '$'
    {0x18,0x18,0x7C,0xC6,0xC2,0xC0,0x7C,0x06,0x06,0x86,0xC6,0x7C,0x18,0x18,0x00,0x00},
    // 37 '%'
    {0x00,0x00,0x00,0x00,0xC2,0xC6,0x0C,0x18,0x30,0x60,0xC6,0x86,0x00,0x00,0x00,0x00},
    // 38 '&'
    {0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    // 39 "'"
    {0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // 40 '('
    {0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00},
    // 41 ')'
    {0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00},
    // 42 '*'
    {0x00,0x00,0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00},
    // 43 '+'
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00},
    // 44 ','
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00},
    // 45 '-'
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // 46 '.'
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    // 47 '/'
    {0x00,0x00,0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00},
    // 48 '0'
    {0x00,0x00,0x7C,0xC6,0xC6,0xCE,0xDE,0xF6,0xE6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 49 '1'
    {0x00,0x00,0x18,0x38,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
    // 50 '2'
    {0x00,0x00,0x7C,0xC6,0x06,0x0C,0x18,0x30,0x60,0xC0,0xC6,0xFE,0x00,0x00,0x00,0x00},
    // 51 '3'
    {0x00,0x00,0x7C,0xC6,0x06,0x06,0x3C,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 52 '4'
    {0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00},
    // 53 '5'
    {0x00,0x00,0xFE,0xC0,0xC0,0xC0,0xFC,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 54 '6'
    {0x00,0x00,0x38,0x60,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 55 '7'
    {0x00,0x00,0xFE,0xC6,0x06,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00},
    // 56 '8'
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 57 '9'
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7E,0x06,0x06,0x06,0x0C,0x78,0x00,0x00,0x00,0x00},
    // 58 ':'
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    // 59 ';'
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00},
    // 60 '<'
    {0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00},
    // 61 '='
    {0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // 62 '>'
    {0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00},
    // 63 '?'
    {0x00,0x00,0x7C,0xC6,0xC6,0x0C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    // 64 '@'
    {0x00,0x00,0x00,0x7C,0xC6,0xC6,0xDE,0xDE,0xDE,0xDC,0xC0,0x7C,0x00,0x00,0x00,0x00},
    // 65 'A'
    {0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // 66 'B'
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x66,0x66,0x66,0x66,0xFC,0x00,0x00,0x00,0x00},
    // 67 'C'
    {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xC0,0xC0,0xC2,0x66,0x3C,0x00,0x00,0x00,0x00},
    // 68 'D'
    {0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00},
    // 69 'E'
    {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    // 70 'F'
    {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    // 71 'G'
    {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xDE,0xC6,0xC6,0x66,0x3A,0x00,0x00,0x00,0x00},
    // 72 'H'
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // 73 'I'
    {0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // 74 'J'
    {0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00},
    // 75 'K'
    {0x00,0x00,0xE6,0x66,0x66,0x6C,0x78,0x78,0x6C,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    // 76 'L'
    {0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    // 77 'M'
    {0x00,0x00,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // 78 'N'
    {0x00,0x00,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // 79 'O'
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 80 'P'
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    // 81 'Q'
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x0C,0x0E,0x00,0x00},
    // 82 'R'
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    // 83 'S'
    {0x00,0x00,0x7C,0xC6,0xC6,0x60,0x38,0x0C,0x06,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 84 'T'
    {0x00,0x00,0xFF,0xDB,0x99,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // 85 'U'
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 86 'V'
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x10,0x00,0x00,0x00,0x00},
    // 87 'W'
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0xEE,0x6C,0x00,0x00,0x00,0x00},
    // 88 'X'
    {0x00,0x00,0xC6,0xC6,0x6C,0x7C,0x38,0x38,0x7C,0x6C,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // 89 'Y'
    {0x00,0x00,0xCC,0xCC,0xCC,0xCC,0x78,0x30,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00},
    // 90 'Z'
    {0x00,0x00,0xFE,0xC6,0x86,0x0C,0x18,0x30,0x60,0xC2,0xC6,0xFE,0x00,0x00,0x00,0x00},
    // 91 '['
    {0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00},
    // 92 '\'
    {0x00,0x00,0x00,0x80,0xC0,0xE0,0x70,0x38,0x1C,0x0E,0x06,0x02,0x00,0x00,0x00,0x00},
    // 93 ']'
    {0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00},
    // 94 '^'
    {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // 95 '_'
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00},
    // 96 '`'
    {0x00,0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // 97 'a'
    {0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    // 98 'b'
    {0x00,0x00,0xE0,0x60,0x60,0x78,0x6C,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00},
    // 99 'c'
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC0,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 100 'd'
    {0x00,0x00,0x1C,0x0C,0x0C,0x3C,0x6C,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    // 101 'e'
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xFE,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 102 'f'
    {0x00,0x00,0x1C,0x36,0x32,0x30,0x78,0x30,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00},
    // 103 'g'
    {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0xCC,0x78,0x00},
    // 104 'h'
    {0x00,0x00,0xE0,0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    // 105 'i'
    {0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // 106 'j'
    {0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00},
    // 107 'k'
    {0x00,0x00,0xE0,0x60,0x60,0x66,0x6C,0x78,0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00},
    // 108 'l'
    {0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // 109 'm'
    {0x00,0x00,0x00,0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0xD6,0xC6,0x00,0x00,0x00,0x00},
    // 110 'n'
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00},
    // 111 'o'
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 112 'p'
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00},
    // 113 'q'
    {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0x0C,0x1E,0x00},
    // 114 'r'
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x76,0x66,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    // 115 's'
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 116 't'
    {0x00,0x00,0x10,0x30,0x30,0xFC,0x30,0x30,0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00},
    // 117 'u'
    {0x00,0x00,0x00,0x00,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    // 118 'v'
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x00,0x00,0x00,0x00},
    // 119 'w'
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0x6C,0x00,0x00,0x00,0x00},
    // 120 'x'
    {0x00,0x00,0x00,0x00,0x00,0xC6,0x6C,0x38,0x38,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00},
    // 121 'y'
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7E,0x06,0x0C,0xF8,0x00},
    // 122 'z'
    {0x00,0x00,0x00,0x00,0x00,0xFE,0xCC,0x18,0x30,0x60,0xC6,0xFE,0x00,0x00,0x00,0x00},
    // 123 '{'
    {0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00},
    // 124 '|'
    {0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00},
    // 125 '}'
    {0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00},
    // 126 '~'
    {0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};
// clang-format on

// Framebuffer state
static uint32_t* fb_base = nullptr;
static uint32_t  fb_width = 0;
static uint32_t  fb_height = 0;
static uint32_t  fb_pitch = 0;    // bytes per scanline

// Text cursor
static uint32_t cols = 0;      // characters per row
static uint32_t rows = 0;      // characters per column
static uint32_t cur_x = 0;
static uint32_t cur_y = 0;

// Colors (32-bit ARGB/XRGB)
static constexpr uint32_t FG_COLOR = 0x00AAAAAA;  // light grey
static constexpr uint32_t BG_COLOR = 0x00000000;  // black

static bool active = false;

// Early boot log: buffer output before framebuffer is mapped
static constexpr int EARLY_LOG_SIZE = 8192;
static char early_log[EARLY_LOG_SIZE];
static int  early_log_pos = 0;

// Cursor blinking state
static bool cursor_visible = true;
static uint32_t cursor_tick = 0;
static constexpr uint32_t CURSOR_BLINK_RATE = 50;  // toggle every 50 ticks (0.5s at 100Hz)
static constexpr uint32_t CURSOR_COLOR = 0x00AAAAAA;  // same as FG_COLOR

static void draw_cursor() {
    if (!active) return;
    // Draw underscore cursor: fill bottom 2 rows of the character cell
    uint32_t x0 = cur_x * FONT_W;
    uint32_t y0 = cur_y * FONT_H + (FONT_H - 2);  // last 2 pixel rows
    for (int row = 0; row < 2; row++) {
        uint32_t* pixel = (uint32_t*)((uint8_t*)fb_base + (y0 + row) * fb_pitch) + x0;
        for (int col = 0; col < FONT_W; col++) {
            pixel[col] = CURSOR_COLOR;
        }
    }
}

static void erase_cursor() {
    if (!active) return;
    uint32_t x0 = cur_x * FONT_W;
    uint32_t y0 = cur_y * FONT_H + (FONT_H - 2);
    for (int row = 0; row < 2; row++) {
        uint32_t* pixel = (uint32_t*)((uint8_t*)fb_base + (y0 + row) * fb_pitch) + x0;
        for (int col = 0; col < FONT_W; col++) {
            pixel[col] = BG_COLOR;
        }
    }
}

// -------------------------------------------------------------------------
static inline void draw_pixel(uint32_t x, uint32_t y, uint32_t color) {
    // pitch is in bytes; each pixel is 4 bytes for 32-bpp
    uint32_t* row = (uint32_t*)((uint8_t*)fb_base + y * fb_pitch);
    row[x] = color;
}

static void draw_char(uint32_t cx, uint32_t cy, int ch) {
    if (ch < 32 || ch > 126) ch = '?';
    const uint8_t* glyph = font8x16[ch - 32];

    uint32_t x0 = cx * FONT_W;
    uint32_t y0 = cy * FONT_H;

    for (int row = 0; row < FONT_H; row++) {
        uint8_t bits = glyph[row];
        uint32_t* pixel = (uint32_t*)((uint8_t*)fb_base + (y0 + row) * fb_pitch) + x0;
        for (int col = 0; col < FONT_W; col++) {
            *pixel++ = (bits & 0x80) ? FG_COLOR : BG_COLOR;
            bits <<= 1;
        }
    }
}

static void clear_row(uint32_t cy) {
    uint32_t y0 = cy * FONT_H;
    for (int row = 0; row < FONT_H; row++) {
        uint32_t* pixel = (uint32_t*)((uint8_t*)fb_base + (y0 + row) * fb_pitch);
        for (uint32_t x = 0; x < fb_width; x++) {
            pixel[x] = BG_COLOR;
        }
    }
}

static void scroll_up() {
    // Move all rows up by one character row (FONT_H pixels)
    uint32_t bytes_per_char_row = fb_pitch * FONT_H;
    uint8_t* dst = (uint8_t*)fb_base;
    uint8_t* src = dst + bytes_per_char_row;
    uint32_t total = bytes_per_char_row * (rows - 1);

    // Copy byte-by-byte (no memcpy available with guaranteed alignment)
    for (uint32_t i = 0; i < total; i++) {
        dst[i] = src[i];
    }

    // Clear last row
    clear_row(rows - 1);
}

// -------------------------------------------------------------------------
// Public API
// -------------------------------------------------------------------------

void init(uintptr_t fb_vaddr, uint32_t width, uint32_t height, uint32_t pitch, uint8_t bpp) {
    if (bpp != 32 || fb_vaddr == 0 || width == 0 || height == 0) return;

    fb_base   = (uint32_t*)fb_vaddr;
    fb_width  = width;
    fb_height = height;
    fb_pitch  = pitch;

    cols = width  / FONT_W;
    rows = height / FONT_H;
    cur_x = 0;
    cur_y = 0;

    // Clear screen
    for (uint32_t y = 0; y < height; y++) {
        uint32_t* pixel = (uint32_t*)((uint8_t*)fb_base + y * fb_pitch);
        for (uint32_t x = 0; x < width; x++) {
            pixel[x] = BG_COLOR;
        }
    }

    active = true;

    // Replay buffered early boot output
    for (int i = 0; i < early_log_pos; i++) {
        putc(early_log[i]);
    }
    early_log_pos = 0;
}

void putc(int c) {
    if (!active) {
        // Buffer output until framebuffer is ready
        if (early_log_pos < EARLY_LOG_SIZE)
            early_log[early_log_pos++] = (char)c;
        return;
    }

    // Erase old cursor before updating position
    if (cursor_visible) erase_cursor();

    switch (c & 0xFF) {
    case '\n':
        cur_x = 0;
        cur_y++;
        break;
    case '\r':
        cur_x = 0;
        break;
    case '\b':
        if (cur_x > 0) {
            cur_x--;
            draw_char(cur_x, cur_y, ' ');
        }
        break;
    case '\t':
        // Advance to next 8-column tab stop
        cur_x = (cur_x + 8) & ~7;
        if (cur_x >= cols) {
            cur_x = 0;
            cur_y++;
        }
        break;
    default:
        draw_char(cur_x, cur_y, c);
        cur_x++;
        if (cur_x >= cols) {
            cur_x = 0;
            cur_y++;
        }
        break;
    }

    // Scroll if needed
    if (cur_y >= rows) {
        scroll_up();
        cur_y = rows - 1;
    }

    // Redraw cursor at new position
    cursor_visible = true;
    cursor_tick = 0;
    draw_cursor();
}

void tick() {
    if (!active) return;
    cursor_tick++;
    if (cursor_tick >= CURSOR_BLINK_RATE) {
        cursor_tick = 0;
        if (cursor_visible) {
            erase_cursor();
            cursor_visible = false;
        } else {
            draw_cursor();
            cursor_visible = true;
        }
    }
}

bool is_active() {
    return active;
}

void late_init() {
    struct boot_info *bi = &::__kernel_boot_info;

    cprintf("fbcons_late_init: type=%d addr=0x%lx w=%d h=%d pitch=%d bpp=%d\n",
            bi->framebuffer_type, (unsigned long)bi->framebuffer_addr,
            bi->framebuffer_width, bi->framebuffer_height,
            bi->framebuffer_pitch, bi->framebuffer_bpp);

    if (bi->framebuffer_type != 1 || bi->framebuffer_addr == 0) {
        cprintf("fbcons: no framebuffer available\n");
        return;
    }

    uint64_t fb_phys = bi->framebuffer_addr;
    uint32_t fb_size = bi->framebuffer_pitch * bi->framebuffer_height;

    // Map framebuffer into kernel virtual address space
    uintptr_t fb_va = mmio_map((uintptr_t)fb_phys, fb_size, PTE_W | PTE_PCD | PTE_PWT);

    cprintf("fbcons: phys 0x%lx -> virt 0x%lx (%dx%d)\n",
            (unsigned long)fb_phys, (unsigned long)fb_va,
            bi->framebuffer_width, bi->framebuffer_height);

    init(fb_va, bi->framebuffer_width, bi->framebuffer_height,
         bi->framebuffer_pitch, bi->framebuffer_bpp);
}

} // namespace fbcons

#endif // CONFIG_FBCONS
